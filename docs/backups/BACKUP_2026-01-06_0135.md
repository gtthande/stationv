# Backup Snapshot: Station-2100
**Date:** 2026-01-06 01:35  
**Purpose:** Pre-fix snapshot before RBAC/API debugging  
**Status:** Suppliers module + RBAC super-user groundwork in progress

---

## üéØ CURRENT PROBLEM

**Issue:** Suppliers API returns 403 (Permission Denied) despite RBAC super-user bypass logic being implemented.

**Symptoms:**
- UI loads successfully at `/dashboard/suppliers`
- API calls to `/api/suppliers` return 403 with message: "suppliers:read permission required"
- Super-user bypass logic exists in `lib/rbac.ts` but appears not to be working
- User is confirmed to be admin (`isAdmin: true, isActive: true`)

**Expected Behavior:**
- Super users (isAdmin === true && isActive === true) should bypass all permission checks
- API should return 200 with supplier data

---

## üìä CURRENT STATE

### ‚úÖ What's Working
- **UI Layer:** Suppliers page renders correctly with all components
- **Database:** MySQL database intact, suppliers table exists
- **RBAC Logic:** Super-user bypass functions implemented in `lib/rbac.ts`
- **Authentication:** Temporary auth helper returns first active admin user
- **Other Pages:** 
  - `/dashboard` - Working
  - `/admin/permissions` - Working
  - `/dashboard/suppliers` - UI loads, API blocked

### ‚ö†Ô∏è What's Not Working
- **Suppliers API:** Returns 403 despite super-user status
- **Permission Check:** `can()` function may not be properly checking super-user status before permission lookup

---

## üìÅ FILES RECENTLY TOUCHED

### RBAC & Authentication
- `lib/rbac.ts` - Added super-user bypass logic to `can()`, `canAny()`, `canAll()`
- `lib/auth.ts` - Temporary auth helper (returns first active admin)

### Suppliers Module
- `app/api/suppliers/route.ts` - GET and POST endpoints with RBAC checks
- `app/dashboard/suppliers/page.tsx` - Client-side suppliers page
- `app/dashboard/suppliers/_components/` - SupplierForm, SuppliersTable components
- `lib/services/supplierService.ts` - Service layer (if exists)

### Supporting Files
- `lib/types.ts` - Added Supplier interface
- `components/ui/Input.tsx` - Updated input component
- `prisma/schema.prisma` - Supplier model definition
- `sql/schema.sql` - SQL schema updates

---

## üîç KEY CODE PATTERNS

### RBAC Super-User Bypass (lib/rbac.ts)
```typescript
// Pattern: Check isAdmin FIRST before any permission lookup
const user = await prisma.user.findUnique({
  where: { id: userId },
  select: { isAdmin: true, isActive: true },
});

if (user?.isAdmin === true && user?.isActive === true) {
  return true; // Bypass all checks
}
```

### Suppliers API Permission Check (app/api/suppliers/route.ts)
```typescript
const userId = await getCurrentUserId();
const hasPermission = await can(userId, 'suppliers:read');
if (!hasPermission) {
  return NextResponse.json({ error: 'Permission denied' }, { status: 403 });
}
```

### Temporary Auth Helper (lib/auth.ts)
```typescript
// Returns first active admin user (temporary until NextAuth is set up)
const user = await prisma.user.findFirst({
  where: { isAdmin: true, isActive: true },
  orderBy: { createdAt: 'asc' },
});
```

---

## üóÑÔ∏è DATABASE STATE

**Database Name:** `stationv_clean` (inferred from existing dumps)

**Existing Backups:**
- `database_dumps/stationv_clean.sql` - Full database dump
- `database_dumps/suppliers_import_mysql.sql` - Suppliers import script
- `database_dumps/customers_rows.sql` - Customers data
- `database_dumps/suppliers_rows.sql` - Suppliers data

**Key Tables:**
- `users` - User accounts with `isAdmin` and `isActive` flags
- `permissions` - Permission definitions
- `user_permissions` - User-permission mappings
- `suppliers` - Supplier records (BigInt ID)

---

## üîÑ RESTORE PROCEDURE

### Code Restore
```bash
# View commit history
git log --oneline

# Restore to this backup commit
git checkout <commit-hash>

# Or restore specific files
git checkout <commit-hash> -- <file-path>
```

### Database Restore
```bash
# Restore from existing dump
mysql -u <user> -p stationv_clean < database_dumps/stationv_clean.sql

# Or create new dump before changes
mysqldump -u <user> -p --databases stationv_clean > backups/stationv_clean_backup_2026-01-06_0135.sql
```

---

## üö® KNOWN ISSUES TO INVESTIGATE

1. **RBAC Bypass Not Working**
   - Super-user check may not be executing before permission lookup
   - Possible race condition or async issue
   - Check if `getCurrentUserId()` returns correct user ID

2. **Permission Key Mismatch**
   - API checks for `'suppliers:read'` but permission may be stored differently
   - Verify permission keys in database match API expectations

3. **Auth Helper Timing**
   - Temporary auth helper may not be returning user synchronously
   - Check if `getCurrentUserId()` is awaited properly in API route

---

## üìù NEXT STEPS (After Backup)

1. **Debug RBAC Flow**
   - Add console logs to trace permission check execution
   - Verify `getCurrentUserId()` returns expected user
   - Verify `can()` function receives correct parameters

2. **Verify Database State**
   - Confirm admin user exists with `isAdmin: true, isActive: true`
   - Check if `suppliers:read` permission exists in database
   - Verify user-permission mappings

3. **Test Permission Bypass**
   - Create isolated test for `can()` function with super-user
   - Verify bypass logic executes before permission lookup

---

## ‚úÖ BACKUP VERIFICATION

- [x] Git status checked
- [x] Uncommitted changes identified
- [x] Backup documentation created
- [x] Database dump location confirmed
- [x] Environment files verified (not committed)
- [x] Restore procedure documented

---

**Backup Created:** 2026-01-06 01:35  
**Commit Hash:** (Will be added after commit)  
**Safe to Continue:** ‚úÖ Yes - All changes documented, restore path confirmed

