generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

// ═══════════════════════════════════════════════════════════
// EXISTING TABLE (DO NOT MODIFY)
// ═══════════════════════════════════════════════════════════

model customers {
  id             String   @id @db.Char(36)
  user_id        String   @db.Char(36)
  name           String   @db.VarChar(255)
  email          String?  @db.VarChar(255)
  phone          String?  @db.VarChar(20)
  address        String?  @db.Text
  city           String?  @db.VarChar(100)
  state          String?  @db.VarChar(100)
  zip_code       String?  @db.VarChar(20)
  country        String?  @db.VarChar(100)
  contact_person String?  @db.VarChar(255)
  tail_number    String?  @db.VarChar(20)
  aircraft_type  String?  @db.VarChar(100)
  notes          String?  @db.Text
  created_at     DateTime @default(now()) @db.DateTime(0)
  updated_at     DateTime @db.DateTime(0)

  @@index([user_id], map: "customers_user_id_fkey")
}

// ═══════════════════════════════════════════════════════════
// USER MODEL
// ═══════════════════════════════════════════════════════════

model User {
  id              String           @id @default(uuid())
  name            String
  email           String           @unique
  password        String           // bcrypt hashed
  isActive        Boolean          @default(true)
  isAdmin         Boolean          @default(false)
  lastLogin       DateTime?
  createdAt       DateTime         @default(now())
  updatedAt       DateTime         @updatedAt
  createdBy       String?
  
  // Relations
  userPermissions UserPermission[]
  auditLogs       AuditLog[]
  
  // Indexes
  @@index([email])
  @@map("users")
}

// ═══════════════════════════════════════════════════════════
// PERMISSION MODEL
// ═══════════════════════════════════════════════════════════

model Permission {
  id              String           @id @default(uuid())
  key             String           @unique  // e.g., "inventory.view"
  description     String
  module          String           // e.g., "Inventory", "JobCard", "Admin"
  category        String?          // e.g., "Read", "Write", "Approve"
  isActive        Boolean          @default(true)
  createdAt       DateTime         @default(now())
  
  // Relations
  userPermissions UserPermission[]
  
  // Indexes
  @@index([module])
  @@index([key])
  @@map("permissions")
}

// ═══════════════════════════════════════════════════════════
// USER-PERMISSION JUNCTION TABLE
// ═══════════════════════════════════════════════════════════

model UserPermission {
  id           String      @id @default(uuid())
  user         User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId       String
  permission   Permission  @relation(fields: [permissionId], references: [id], onDelete: Cascade)
  permissionId String
  grantedBy    String?     // Who granted this permission
  grantedAt    DateTime    @default(now())
  
  // Constraints
  @@unique([userId, permissionId])
  @@index([userId])
  @@index([permissionId])
  @@map("user_permissions")
}

// ═══════════════════════════════════════════════════════════
// AUDIT LOG MODEL
// ═══════════════════════════════════════════════════════════

model AuditLog {
  id          String   @id @default(uuid())
  user        User?    @relation(fields: [userId], references: [id])
  userId      String?
  action      String   // e.g., "user.created", "permission.granted"
  module      String   // e.g., "Admin", "Inventory"
  details     Json?    // Additional context
  ipAddress   String?
  userAgent   String?
  timestamp   DateTime @default(now())
  
  // Indexes
  @@index([userId])
  @@index([action])
  @@index([timestamp])
  @@map("audit_logs")
}

// ═══════════════════════════════════════════════════════════
// SUPPLIERS MODEL
// ═══════════════════════════════════════════════════════════

model Supplier {
  id          BigInt   @id @default(autoincrement()) @db.UnsignedBigInt
  code        String?  @unique @db.VarChar(50)
  name        String   @db.VarChar(255)
  contactName String?  @map("contact_name") @db.VarChar(255)
  email       String?  @db.VarChar(255)
  phone       String?  @db.VarChar(50)
  country     String?  @default("Kenya") @db.VarChar(100)
  city        String?  @db.VarChar(100)
  address     String?  @db.Text
  notes       String?  @db.Text
  isActive    Boolean  @default(true) @map("is_active")
  createdAt   DateTime @default(now()) @map("created_at") @db.DateTime(0)
  updatedAt   DateTime @updatedAt @map("updated_at") @db.DateTime(0)
  
  @@map("suppliers")
}
